<!Doctype html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    <!-- 부트스트랩 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <!--    부트스트랩-->
    <!--    아이콘-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <!--    아이콘-->
    <!-- header css -->
    <link rel="stylesheet" th:href="@{/css/header.css}">

    <style>
        .search-container {
            border: 2px solid black; /* 테두리 색상 */
            border-radius: 5px; /* 테두리 모서리 둥글게 */
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1); /* 그림자 추가 */
            color: black; /* 텍스트 색상 설정 */
        }

        #searchData {
            border: none; /* 검색 입력창에는 별도의 테두리 제거 */
            background-color: whitesmoke; /* 배경색상 설정 */

            .custom-textarea {
                width: 100%; /* 너비 100% */
                height: 200px; /* 높이 200px로 설정 */
            }
        }
    </style>

    <title>시나리오 생성</title>

</head>
<body>

<div th:replace="~{/includes/header :: header}"></div>
<div class="container text-center mt-5">

    <!-- 검색 입력 부분 -->
    <div class="row search-container mb-3">
        <div class="col-12 d-flex py-1">
            <input id="searchData" class="form-control me-2" type="search" placeholder="키를 검색하세요"
                   aria-label="Search">
            <button id="searchBtn" class="btn btn-outline-primary" type="button">
                <svg style="display:inline-block" xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                     fill="currentColor" class="bi bi-search" viewBox="0 0 16 16">
                    <path
                            d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
                </svg>
            </button>
        </div>
    </div>


    <div class="container mt-5">
        <form id="filterForm">
            <!-- Filter form fields -->
            <div class="form-row">
                <div class="col-md-3 mb-3">
                    <label for="key"><b>키</b></label>
                    <select class="form-control" id="key" name="key" required>
                        <option value="cust_id">고객번호</option>
                        <option value="cust_age">고객나이</option>
                        <option value="loc">고객주소</option>

                    </select>
                </div>
                <div class="col-md-3 mb-3">
                    <label for="operator"><b>연산자</b></label>
                    <select class="form-control" id="operator" name="operator" required>
                        <option value="<">&lt; (미만)</option>
                        <option value=">">&gt; (초과)</option>
                        <option value="<=">&le; (이하)</option>
                        <option value=">=">&ge; (이상)</option>
                        <option value="=">= (같음)</option>
                        <option value="!=">!= (다름)</option>
                    </select>
                </div>
                <div class="col-md-3 mb-3">
                    <label for="value"><b>값</b></label>
                    <input type="text" class="form-control" id="value" name="value" required>
                </div>
                <div class="col-md-3 mb-3">
                    <label for="filterType"><b>값 타입</b></label>
                    <select class="form-control" id="filterType" name="filterType" required>
                        <option value="number">숫자</option>
                        <option value="string">문자</option>
                    </select>
                </div>
            </div>

            <!-- Add filter button -->
            <button type="button" class="btn btn-primary" onclick="addFilter()">필터 추가</button>
            <button type="button" class="btn btn-danger" onclick="resetForm()">리셋 폼</button>
            <button type="button" class="btn btn-success" onclick="addLogicalOperator('AND')">AND</button>
            <button type="button" class="btn btn-warning" onclick="addLogicalOperator('OR')">OR</button>
        </form>

        <!-- Display added filters with buttons for each -->
        <div id="filterDisplay" class="mt-4"></div>
        <div class="row">
            <!-- Display filter tree -->
            <div class="col-6">
                <h5><b>필터 Json 트리</b></h5>
                <div id="filterTree" class="mt-4">
                    <pre id="filterTreeContent" class="text-start" style="border : 1px solid black"></pre>
                </div>
            </div>
            <div class="col-6">
                <h5><b>필터 트리</b></h5>
                <div id="filterTreeButtons" class="mt-4" style="border : 1px solid black">

                </div>
            </div>
        </div>
    </div>

    <!-- 테이블 부분 -->
    <div class="row justify-content-center">
        <div class="col-12">
            <div class="row pb-3">
                <div class="col">
                    <!-- 플러스 버튼 모달 토글 버튼 -->
                    <button type="button" class="btn btn-danger">
                        시나리오 생성
                    </button>
                </div>
            </div>
            <div class="d-grid gap-2">
                <a class="btn btn-outline-primary" type="button" href="\scenario-management"><b>+Go To Manage Scenario+</b></a>
                <a class="btn btn-outline-primary" type="button" href="\key-management"><b>+Go To Manage Keys+</b></a>
            </div>
        </div>
    </div>

</div>

<div th:replace="~{/includes/footer :: footer}"></div>
<!-- 제이쿼리 추가 -->
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
<script>
    // 행 추가 버튼 클릭 시 실행되는 함수
    $('#add-filter-btn').on('click', function () {
        // 새로운 행을 생성
        var newRow = $('<tr>').append(
            $('<td>').text('새로 선택한 키이름'),
            $('<td>').text('새로 선택한 옵션 '),
            $('<td>').text('새로 입력 또는 선택한 값'),
            $('<td>').append('<button class="btn btn-danger deleteBtn">삭제</button>')
        );

        // 생성한 행을 테이블에 추가
        $('#filter-table-body').append(newRow);

        // 테이블 행이 2개 이상일 때만 조건부 div를 보여줌
        if ($('#filter-table-body tr').length >= 2) {
            $('#operator-select-div').show();
        }
    });

    // 테이블에서 삭제 버튼 클릭 시 실행되는 함수
    $('#filter-table-body').on('click', '.deleteBtn', function () {
        // 현재 행을 삭제
        $(this).closest('tr').remove();

        // 테이블 행이 2개 미만이면 조건부 div를 숨김
        if ($('#filter-table-body tr').length < 2) {
            $('#operator-select-div').hide();
        }
    });
</script>
<script th:inline="javascript">
    /*<![CDATA[*/
    var filterTree = [];

    function addFilter() {
        var key = $('#key').val();
        var operator = $('#operator').val();
        var value = $('#value').val();
        var filterType = $('#filterType').val();

        // Create filter object
        var filter = {
            key: key,
            operator: operator,
            value: value,
            filterType: filterType
        };

        if (filterTree.length === 0 || (filterTree.length > 0 && filterTree[filterTree.length - 1].hasOwnProperty('logicalOperator'))) {
            // Add filter to filter tree
            addToFilterTree(filter);

            // Render the filter tree
            renderFilterTree();

            // Display the filter
            // displayFilter(filter);
            // displayFilter(filterTree);
            renderFilterButtons();

            // Reset the form
            resetForm();
        }else{
            alert("AND/OR 콤보가 필요합니다");
        }

    }

    function addLogicalOperator(logicalOperator) {
        // Create logical operator object
        var logicalOperatorObj = {
            logicalOperator: logicalOperator
        };

        if(!filterTree[filterTree.length - 1].hasOwnProperty('logicalOperator')){
            // Add logical operator to filter tree
            addToFilterTree(logicalOperatorObj);

            // Render the filter tree
            renderFilterTree();

            // Display the logical operator
            displayLogicalOperator(logicalOperator);
        }else{
            alert("필터를 먼저 추가해주세요.");
        }

    }

    function addToFilterTree(filter) {
        filterTree.push(filter);
    }

    function displayLogicalOperator(logicalOperator) {
        // Add button for logical operator to the tree buttons
        var logicalOperatorButton = $('<button>').addClass('btn btn-info m-2').text(logicalOperator);
        logicalOperatorButton.click(function () {
            editLogicalOperator(logicalOperator);
        });

        // Add delete button for logical operator
        var deleteButton = $('<button>').addClass('btn btn-danger m-2').text('삭제');
        deleteButton.click(function () {
            deleteLogicalOperator(logicalOperatorButton);
        });

        // Create a container div for each logical operator and its buttons in the filter tree
        var logicalOperatorContainer = $('<div>').addClass('d-flex flex-row align-items-center');
        logicalOperatorContainer.append(logicalOperatorButton, deleteButton);

        // Append the container div to the filter tree buttons
        $('#filterTreeButtons').append(logicalOperatorContainer);
    }

    function editLogicalOperator(logicalOperator) {
        // Logical operator buttons are not editable
    }

    function deleteLogicalOperator(logicalOperatorButton) {
        // Find the index of the parent div and remove the logical operator from the tree
        var index = $('#filterTreeButtons').children('div').index(logicalOperatorButton.parent());
        filterTree.splice(index, 2);
        // $(this).parent().remove();
        $('#filterTreeContent').text(JSON.stringify(filterTree, null, 2));

        // Remove the logical operator buttons
        logicalOperatorButton.parent().remove();

        // 갱신된 필터 트리를 다시 렌더링
        renderFilterTree();
        renderFilterButtons();
    }

    function editFilter(filter) {
        var key = prompt('Enter a new key:', filter.key);
        if (key !== null) {
            filter.key = key;
            renderFilterTree();
            renderFilterButtons();
        }
    }



    function deleteFilter(index) {

        filterTree.splice(index, 1);
        $('#filterTreeContent').text(JSON.stringify(filterTree, null, 2));
        // Remove the filter display

        // Remove the property buttons
        $('#filterTreeButtons button').eq(index).parent().remove();
        // $('#filterTreeButtons').children().eq(index).remove();
        $('#filterDisplay').children().eq(index).remove();
        alert(index);

        // 갱신된 필터 트리를 다시 렌더링
        renderFilterTree();
        renderFilterButtons();
    }



    function resetForm() {
        // Reset the form fields
        $('#key').val('');
        $('#operator').val('');
        $('#value').val('');
        $('#filterType').val('number');
    }

    function renderFilterTree() {
        // 갱신된 필터 트리를 다시 렌더링
        $('#filterTreeContent').text(JSON.stringify(filterTree, null, 2));
    }

    function renderFilterButtons() {
        // Remove all buttons
        $('#filterTreeButtons').empty();
        $('#filterDisplay').empty();
        // Add buttons for each filter property
        filterTree.forEach(function (item, index) {
            if (item.hasOwnProperty('key')) {
                var filterButton = $('<button>').addClass('btn btn-secondary m-2').text(item.key + ' ' + item.operator + ' ' + item.value);
                filterButton.click(function () {
                    editFilter(item);
                });

                // Add delete button for filter
                var deleteButton = $('<button>').addClass('btn btn-danger m-2').text('삭제');
                deleteButton.click(function () {
                    deleteFilter(index);
                });

                // Add add subfilter button for filter
                var addSubfilterButton = $('<button>').addClass('btn btn-success m-2').text('하위 필터 추가');
                addSubfilterButton.click(function () {
                    alert('Add Subfilter clicked for: ' + item.key );
                });

                // Create a container div for each filter and its buttons in the filter tree
                var filterContainer = $('<div>').addClass('d-flex flex-row align-items-center');
                filterContainer.append(filterButton, deleteButton, addSubfilterButton);

                $('#filterTreeButtons').append(filterContainer);

                //display
                // Create a div element to display the filter
                var filterDiv = $('<div>').addClass('alert alert-info alert-dismissible fade show').attr('role', 'alert');

                // Display filter information
                filterDiv.html('<strong>' + item.key + '</strong> ' + item.operator + ' <span class="badge badge-secondary">' +
                    item.value + '</span> (' + item.filterType + ')');

                // Add close button
                filterDiv.append('<button type="button" class="close" data-dismiss="alert" aria-label="Close" onclick="deleteFilter('+index+')">' +
                    '<span aria-hidden="true">&times;</span></button>');

                // Append the filter div to the display div
                $('#filterDisplay').append(filterDiv);
                //display
            } else if (item.hasOwnProperty('logicalOperator')) {

                // Add button for logical operator to the tree buttons
                var logicalOperatorButton = $('<button>').addClass('btn btn-info m-2').text(item.logicalOperator);
                logicalOperatorButton.click(function () {
                    editLogicalOperator(item.logicalOperator);
                });


                // Add delete button for logical operator
                var deleteButton = $('<button>').addClass('btn btn-danger m-2').text('삭제');
                deleteButton.click(function () {
                    deleteLogicalOperator(logicalOperatorButton);
                });

                // Create a container div for each logical operator and its buttons in the filter tree
                var logicalOperatorContainer = $('<div>').addClass('d-flex flex-row align-items-center');
                logicalOperatorContainer.append(logicalOperatorButton, deleteButton);

                $('#filterTreeButtons').append(logicalOperatorContainer);
            }
        });
    }



    /*]]>*/
</script>

</body>
</html>